name: POC Trivy github markdown template
description: A template for creating a Trivy GitHub Action workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ vars.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ghrc.io/thirapat12/trivy-node:12-alpine

      - name: Create Trivy GitHub Markdown Template
        run: |
          mkdir -p .trivy
          cat <<EOF > .trivy/github-markdown.tpl
          ## 📊 **Trivy Scan Summary**

          {{ $crit := 0 }}{{ $high := 0 }}{{ $med := 0 }}{{ $low := 0 }}{{ $unk := 0 }}

          {{- range . }}
            {{- range .Vulnerabilities }}
              {{- if eq .Severity "CRITICAL" }}{{ $crit = add $crit 1 }}{{ end }}
              {{- if eq .Severity "HIGH" }}{{ $high = add $high 1 }}{{ end }}
              {{- if eq .Severity "MEDIUM" }}{{ $med = add $med 1 }}{{ end }}
              {{- if eq .Severity "LOW" }}{{ $low = add $low 1 }}{{ end }}
              {{- if eq .Severity "UNKNOWN" }}{{ $unk = add $unk 1 }}{{ end }}
            {{- end }}
          {{- end }}

          ### 🚨 **Vulnerability Count Summary**

          | Severity       | Count        |
          |----------------|--------------|
          | 🟥 **`CRITICAL`** | **{{ $crit }}** |
          | 🟧 **`HIGH`**     | **{{ $high }}** |
          | 🟨 `MEDIUM`     | {{ $med }}       |
          | 🟦 `LOW`        | {{ $low }}       |
          | ⬜ `UNKNOWN`    | {{ $unk }}       |

          ---

          {{- range . }}
          ### 🔍 **Target**: `{{ .Target }}`
          {{- if .Class }}  
          *Class*: `{{ .Class }}`  
          {{- end }}
          {{- if .Type }}
          *Type*: `{{ .Type }}`  
          {{- end }}

          {{- if .Vulnerabilities }}

          #### 🟥 **CRITICAL**
          {{- range .Vulnerabilities }}
          {{- if eq .Severity "CRITICAL" }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}
          {{- end }}

          #### 🟧 **HIGH**
          {{- range .Vulnerabilities }}
          {{- if eq .Severity "HIGH" }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}
          {{- end }}

          #### 🟨 MEDIUM
          {{- range .Vulnerabilities }}
          {{- if eq .Severity "MEDIUM" }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}
          {{- end }}

          #### 🟦 LOW
          {{- range .Vulnerabilities }}
          {{- if eq .Severity "LOW" }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}
          {{- end }}

          #### ⬜ UNKNOWN
          {{- range .Vulnerabilities }}
          {{- if eq .Severity "UNKNOWN" }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}
          {{- end }}

          {{- else }}
          ✅ No vulnerabilities found.
          {{- end }}

          {{ end }}
          EOF        

      - name: Trivy image Scan
        id: trivy
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ghrc.io/thirapat12/trivy-node:12-alpine
          format: template
          template: '@.trivy/github-markdown.tpl'
          output: 'trivy-report.md'
          exit-code: 0
          ignore-unfixed: true

      - name: Upload Trivy Report to GitHub Summary
        run: |
          cat trivy-report.md >> $GITHUB_STEP_SUMMARY
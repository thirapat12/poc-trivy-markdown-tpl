name: POC Trivy github markdown template
description: A template for creating a Trivy GitHub Action workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  # pull-requests: read
  actions: write

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ vars.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: thirapat12/thirapat12-node:12-alpine

      - name: Create Trivy GitHub Markdown Template
        run: |
          mkdir -p .trivy
          cat <<'EOF' > .trivy/github-markdown.tpl
          ## ðŸ“Š Trivy Scan Summary

          {{ $crit := 0 }}{{ $high := 0 }}{{ $med := 0 }}{{ $low := 0 }}{{ $unk := 0 }}

          {{- range . }}
            {{- range .Vulnerabilities }}
              {{- if eq .Severity "CRITICAL" }}{{ $crit = add $crit 1 }}{{ end }}
              {{- if eq .Severity "HIGH" }}{{ $high = add $high 1 }}{{ end }}
              {{- if eq .Severity "MEDIUM" }}{{ $med = add $med 1 }}{{ end }}
              {{- if eq .Severity "LOW" }}{{ $low = add $low 1 }}{{ end }}
              {{- if eq .Severity "UNKNOWN" }}{{ $unk = add $unk 1 }}{{ end }}
            {{- end }}
          {{- end }}

          ### ðŸš¨ Vulnerability Count Summary

          | Severity       | Count        |
          |----------------|--------------|
          | ðŸŸ¥ **`CRITICAL`** | **{{ $crit }}** |
          | ðŸŸ§ **`HIGH`**     | **{{ $high }}** |
          | ðŸŸ¨ `MEDIUM`     | {{ $med }}       |
          | ðŸŸ¦ `LOW`        | {{ $low }}       |
          | â¬œ `UNKNOWN`    | {{ $unk }}       |

          ---

          {{- range . }}
          ### ðŸ” Target: `{{ .Target }}`
          {{- if .Class }}  
          *Class*: `{{ .Class }}`  
          {{- end }}
          {{- if .Type }}
          *Type*: `{{ .Type }}`  
          {{- end }}

          {{- if .Vulnerabilities }}
          | Package | Vulnerability ID | Severity | Installed | Fixed |
          |---------|------------------|----------|-----------|-------|
          {{- range .Vulnerabilities }}
          | `{{ .PkgName }}` | [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }}) | {{- if eq .Severity "CRITICAL" }}ðŸŸ¥ **`CRITICAL`**{{- else if eq .Severity "HIGH" }}ðŸŸ§ **`HIGH`**{{- else if eq .Severity "MEDIUM" }}ðŸŸ¨ `MEDIUM`{{- else if eq .Severity "LOW" }}ðŸŸ¦ `LOW`{{- else }}â¬œ `UNKNOWN`{{- end }} | `{{ .InstalledVersion }}` | `{{ .FixedVersion }}` |
          {{- end }}
          {{- else }}
          âœ… No vulnerabilities found.
          {{- end }}

          {{- end }}
          ---
          EOF

      - name: Trivy image Scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: thirapat12/thirapat12-node:12-alpine
          format: template
          template: '@.trivy/github-markdown.tpl'
          output: 'trivy-report.md'
          exit-code: 0
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Upload Trivy Report to GitHub Summary
        run: |
          cat trivy-report.md >> $GITHUB_STEP_SUMMARY
name: POC Trivy github markdown template
description: A template for creating a Trivy GitHub Action workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  # pull-requests: read
  actions: write

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ vars.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: thirapat12/thirapat12-node:12-alpine

      - name: Create Trivy GitHub Markdown Template
        run: |
          mkdir -p .trivy
          cat <<'EOF' > .trivy/github-markdown.tpl
          {{ define "output" }}

          ## ðŸ“Š **Trivy Scan Summary**

          ### ðŸš¨ **Vulnerability Count Summary**

          | Severity       | Count |
          |----------------|-------|
          | ðŸŸ¥ **`CRITICAL`** | {{ len (filter . "CRITICAL") }} |
          | ðŸŸ§ **`HIGH`**     | {{ len (filter . "HIGH") }} |
          | ðŸŸ¨ `MEDIUM`     | {{ len (filter . "MEDIUM") }} |
          | ðŸŸ¦ `LOW`        | {{ len (filter .LOW") }} |
          | â¬œ `UNKNOWN`    | {{ len (filter . "UNKNOWN") }} |

          ---

          {{- range . }}
          ### ðŸ” **Target**: `{{ .Target }}`

          {{- if .Vulnerabilities }}

          #### ðŸŸ¥ **CRITICAL**
          {{- range (filterVulns .Vulnerabilities "CRITICAL") }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}

          #### ðŸŸ§ **HIGH**
          {{- range (filterVulns .Vulnerabilities "HIGH") }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}

          #### ðŸŸ¨ MEDIUM
          {{- range (filterVulns .Vulnerabilities "MEDIUM") }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}

          #### ðŸŸ¦ LOW
          {{- range (filterVulns .Vulnerabilities "LOW") }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}

          #### â¬œ UNKNOWN
          {{- range (filterVulns .Vulnerabilities "UNKNOWN") }}
          - **Package**: `{{ .PkgName }}`
            - **Vuln**: [{{ .VulnerabilityID }}](https://avd.aquasec.com/nvd/{{ .VulnerabilityID }})
            - **Installed**: `{{ .InstalledVersion }}`
            - **Fixed**: `{{ .FixedVersion }}`
          {{- end }}

          {{- else }}
          âœ… No vulnerabilities found.
          {{- end }}

          {{- end }}

          {{ end }}
          EOF

      - name: Trivy image Scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: thirapat12/thirapat12-node:12-alpine
          format: template
          template: '@.trivy/github-markdown.tpl'
          output: 'trivy-report.md'
          exit-code: 0
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Upload Trivy Report to GitHub Summary
        run: |
          cat trivy-report.md >> $GITHUB_STEP_SUMMARY